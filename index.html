<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Commit â€” Collaborative Productivity</title>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#317EFB">
<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">


  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQ_JSlyDE7VKsvYXsta7ijhVWIHmU9glE",
      authDomain: "commit-3abb2.firebaseapp.com",
      projectId: "commit-3abb2",
      storageBucket: "commit-3abb2.appspot.com",
      messagingSenderId: "977076161254",
      appId: "1:977076161254:web:dea1cabffe1fba91e58927"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // âœ… correct persistence call for compat SDK
    firebase.firestore().enablePersistence().catch(err => {
      console.warn("Persistence not enabled:", err.code);
    });
  </script>

  <style>
    :root { --brand:#317EFB; --bg:#f9f9f9; --card:#fff; --text:#333; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 24px;
      margin: 0 auto;
      max-width: 860px;
    }
    h1 { text-align:center; margin:0 0 16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, button, select {
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d0d0d0;
      background:#fff;
    }
    button {
      background: var(--brand);
      color:#fff;
      border:none;
      cursor:pointer;
    }
    button:hover { filter: brightness(0.95); }
    .card {
      background: var(--card);
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 14px;
      margin: 14px 0;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }
    .section-title { margin: 6px 0 10px; font-weight: 700; font-size: 18px; }
    ul { list-style:none; margin:0; padding:0; }
    li.task {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; margin:6px 0; background:#fff;
      border:1px solid #eee; border-radius:10px;
    }
    li.task .txt { flex:1; }
    li.task.done .txt { text-decoration: line-through; opacity: 0.7; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #ddd; background:#fafafa; }
    .streak { font-weight:700; }
    #chat-box { height:180px; overflow:auto; background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; }
    .msg { margin:6px 0; }
    .msg b { color:#111; }
    .muted { color:#777; }
    .err { color:#b00020; font-weight:600; }
    .bar { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <h1>ðŸ”¥ Commit</h1>

  <!-- Auth -->
  <div class="card bar">
    <div class="row">
      <button id="signInBtn">Sign in with Google</button>
      <button id="signOutBtn" style="display:none;">Sign out</button>
      <span id="userName" class="muted"></span>
    </div>
    <div id="streakTracker" style="display:none;">
      <span class="streak">ðŸ”¥ Streak: <span id="streakCount">0</span> days</span>
    </div>
  </div>

  <!-- Errors -->
  <div id="errorBox" class="card" style="display:none;">
    <span class="err" id="errorText"></span>
  </div>

  <!-- Tasks -->
  <div class="card">
    <div class="section-title">Tasks</div>
    <div class="row">
      <input id="new-task" placeholder="New taskâ€¦" style="flex:1;" />
      <select id="taskScope">
        <option value="mine">My tasks</option>
        <option value="shared">Shared</option>
      </select>
      <button id="addTaskBtn">Add</button>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px;">
      <div>
        <div class="pill">My tasks</div>
        <ul id="my-task-list"></ul>
      </div>
      <div>
        <div class="pill">Shared</div>
        <ul id="shared-task-list"></ul>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div class="card">
    <div class="section-title">Group Chat</div>
    <div id="chat-box"></div>
    <div class="row">
      <input id="chat-input" placeholder="Type a messageâ€¦" style="flex:1;" />
      <button id="sendMsgBtn">Send</button>
    </div>
  </div>

  <script>
    // tiny helpers
    const $ = sel => document.querySelector(sel);
    const showError = (msg) => { $('#errorText').textContent = msg; $('#errorBox').style.display = 'block'; console.error(msg); };
    const clearError = () => { $('#errorBox').style.display = 'none'; $('#errorText').textContent=''; };

    window.onload = function () {
      const signInBtn = $('#signInBtn');
      const signOutBtn = $('#signOutBtn');
      const userName = $('#userName');
      const streakCount = $('#streakCount');
      const streakTracker = $('#streakTracker');

      const myList = $('#my-task-list');
      const sharedList = $('#shared-task-list');

      let currentUser = null;
      let unsubMyTasks = null;
      let unsubSharedTasks = null;
      let unsubChat = null;

      signInBtn.onclick = () => {
        clearError();
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => showError("Sign-in failed: " + err.message));
      };
      signOutBtn.onclick = () => auth.signOut();

      auth.onAuthStateChanged(user => {
        // cleanup previous listeners
        if (unsubMyTasks) { unsubMyTasks(); unsubMyTasks = null; }
        if (unsubSharedTasks) { unsubSharedTasks(); unsubSharedTasks = null; }
        if (unsubChat) { unsubChat(); unsubChat = null; }

        if (user) {
          currentUser = user;
          signInBtn.style.display = 'none';
          signOutBtn.style.display = 'inline-block';
          userName.textContent = `Hi, ${user.displayName}`;
          streakTracker.style.display = 'block';
          wireTasks(user.uid);
          wireChat();
          updateStreakUI(user.uid);
        } else {
          currentUser = null;
          signInBtn.style.display = 'inline-block';
          signOutBtn.style.display = 'none';
          userName.textContent = '';
          streakTracker.style.display = 'none';
          myList.innerHTML = '';
          sharedList.innerHTML = '';
          $('#chat-box').innerHTML = '';
        }
      });

      // Add task
      $('#addTaskBtn').onclick = async () => {
        clearError();
        const text = $('#new-task').value.trim();
        const scope = $('#taskScope').value; // mine | shared
        if (!currentUser) return showError("Please sign in first.");
        if (!text) return;

        try {
          const ts = firebase.firestore.FieldValue.serverTimestamp();
          if (scope === 'mine') {
            await db.collection('users').doc(currentUser.uid).collection('tasks').add({
              text, completed:false, timestamp: ts
            });
          } else {
            await db.collection('tasks').add({
              text, completed:false, timestamp: ts, author: currentUser.uid
            });
          }
          $('#new-task').value = '';
        } catch (e) {
          showError("Failed to add task: " + e.message);
        }
      };

      // listeners
      function wireTasks(uid) {
        // My tasks (subcollection) â€“ no composite index required
        unsubMyTasks = db.collection('users').doc(uid).collection('tasks')
          .orderBy('timestamp')
          .onSnapshot(snap => {
            renderTaskList(myList, snap, 'user', uid);
          }, err => showError("My tasks error: " + err.message));

        // Shared tasks (top-level)
        unsubSharedTasks = db.collection('tasks')
          .orderBy('timestamp')
          .limit(100)
          .onSnapshot(snap => {
            renderTaskList(sharedList, snap, 'shared', null);
          }, err => showError("Shared tasks error: " + err.message));
      }

      function renderTaskList(container, snapshot, kind, uid) {
        const frag = document.createDocumentFragment();
        snapshot.forEach(doc => {
          const d = doc.data();
          // handle null timestamps gracefully
          const isDone = !!d.completed;
          const li = document.createElement('li');
          li.className = 'task' + (isDone ? ' done' : '');
          li.dataset.kind = kind;           // 'user' | 'shared'
          li.dataset.id = doc.id;           // doc id
          if (uid) li.dataset.uid = uid;    // for user subcollection path

          const txt = document.createElement('span');
          txt.className = 'txt';
          txt.textContent = d.text || '(untitled)';

          const action = document.createElement('button');
          action.textContent = isDone ? 'âœ“' : 'Done';
          action.style.minWidth = '64px';
          action.onclick = (e) => {
            e.stopPropagation();
            markTaskComplete(li.dataset);
          };

          li.appendChild(txt);
          li.appendChild(action);
          frag.appendChild(li);
        });
        container.innerHTML = '';
        container.appendChild(frag);
      }

      async function markTaskComplete(meta) {
        clearError();
        if (!currentUser) return;
        try {
          // Update task doc depending on its collection
          if (meta.kind === 'user') {
            await db.collection('users').doc(meta.uid).collection('tasks')
              .doc(meta.id).update({ completed:true });
          } else {
            await db.collection('tasks').doc(meta.id).update({ completed:true });
          }
          // Streak update
          await tickStreak(currentUser.uid);
        } catch (e) {
          showError("Failed to complete task: " + e.message);
        }
      }

      async function tickStreak(uid) {
        const today = new Date().toDateString();
        const ref = db.collection('streaks').doc(uid);
        const snap = await ref.get();
        let next = 1;
        if (snap.exists) {
          const data = snap.data();
          const last = data.lastCompleted ? new Date(data.lastCompleted).toDateString() : null;
          const yest = new Date(Date.now() - 86400000).toDateString();
          if (last === today) { updateStreakUI(uid); return; }
          next = (last === yest) ? (data.streak || 0) + 1 : 1;
        }
        await ref.set({ streak: next, lastCompleted: today }, { merge:true });
        updateStreakUI(uid);
      }

      function updateStreakUI(uid) {
        db.collection('streaks').doc(uid).get().then(s => {
          if (!s.exists) { streakCount.textContent = '0'; return; }
          const d = s.data();
          const today = new Date().toDateString();
          const last = d.lastCompleted ? new Date(d.lastCompleted).toDateString() : null;
          const yest = new Date(Date.now() - 86400000).toDateString();
          streakCount.textContent = (last === today || last === yest) ? (d.streak || 0) : 0;
        });
      }

      // Chat
      $('#sendMsgBtn').onclick = async () => {
        clearError();
        const msg = $('#chat-input').value.trim();
        if (!currentUser) return showError("Please sign in to chat.");
        if (!msg) return;
        try {
          await db.collection('chat').add({
            name: currentUser.displayName,
            uid: currentUser.uid,
            message: msg,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          $('#chat-input').value = '';
        } catch (e) {
          showError("Failed to send message: " + e.message);
        }
      };

      function wireChat() {
        unsubChat = db.collection('chat').orderBy('timestamp').limit(200)
          .onSnapshot(snap => {
            const frag = document.createDocumentFragment();
            snap.forEach(doc => {
              const d = doc.data();
              const line = document.createElement('div');
              line.className = 'msg';
              line.innerHTML = `<b>${(d.name||'Anon')}</b>: ${d.message||''}`;
              frag.appendChild(line);
            });
            const box = $('#chat-box');
            box.innerHTML = '';
            box.appendChild(frag);
            box.scrollTop = box.scrollHeight;
          }, err => showError("Chat error: " + err.message));
      }
    };
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // use a versioned SW to force updates when you deploy
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('SW registered', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    });
  }
</script>

</body>
</html>
