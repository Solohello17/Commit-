<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Commit â€” Collaborative Productivity</title>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQ_JSlyDE7VKsvYXsta7ijhVWIHmU9glE",
      authDomain: "commit-3abb2.firebaseapp.com",
      projectId: "commit-3abb2",
      storageBucket: "commit-3abb2.appspot.com",
      messagingSenderId: "977076161254",
      appId: "1:977076161254:web:dea1cabffe1fba91e58927"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // offline persistence (compat call)
    firebase.firestore().enablePersistence().catch(err => {
      console.warn("Persistence not enabled:", err.code);
    });
  </script>

  <style>
    :root { --brand:#317EFB; --bg:#f9f9f9; --card:#fff; --text:#333; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 24px; margin: 0 auto; max-width: 900px;
    }
    h1 { text-align:center; margin:0 0 16px; }
    .card { background:var(--card); border:1px solid #e8e8e8; border-radius:12px; padding:14px; margin:14px 0; box-shadow:0 1px 0 rgba(0,0,0,.03); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, button, select {
      font-size:16px; padding:10px 12px; border-radius:8px; border:1px solid #d0d0d0; background:#fff;
    }
    button { background:var(--brand); color:#fff; border:none; cursor:pointer; }
    button.secondary { background:#eef3ff; color:#1f3a8a; border:1px solid #cfe0ff; }
    button:hover { filter: brightness(0.97); }
    .bar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .muted { color:#666; }
    .err { color:#b00020; font-weight:600; }
    .section-title { font-weight:700; font-size:18px; margin:6px 0 10px; }
    ul { list-style:none; margin:0; padding:0; }
    li.task { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; margin:6px 0; background:#fff; border:1px solid #eee; border-radius:10px; }
    li.task.done .txt { text-decoration: line-through; opacity:.7; }
    #chat-box { height:180px; overflow:auto; background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; }
    .msg { margin:6px 0; }
    .auth-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; }
    .auth-panel { display:none; margin-top:10px; }
    .link { background:none; color:#1d4ed8; border:none; padding:0; cursor:pointer; text-decoration:underline; }
  </style>
</head>
<body>
  <h1>ðŸ”¥ Commit</h1>

  <!-- Auth -->
  <div class="card">
    <div class="section-title">Sign in / Sign up</div>

    <!-- Provider buttons -->
    <div class="auth-grid">
      <button id="btnGoogle">Continue with Google</button>
      <button id="btnGithub" class="secondary">Continue with GitHub</button>
      <button id="btnMicrosoft" class="secondary">Continue with Microsoft</button>
      <button id="btnAnon" class="secondary" title="Temporary session; you can link later">Continue as Guest</button>
    </div>

    <!-- Email panel toggles -->
    <div class="row" style="margin-top:8px;">
      <button id="toggleEmail" class="link">Use email & password</button>
      <button id="toggleEmailSignIn" class="link">I already have an account</button>
    </div>

    <!-- Email Sign Up -->
    <div id="emailPanel" class="auth-panel">
      <div class="row">
        <input id="emailUp" type="email" placeholder="Email" style="flex:1;">
        <input id="passUp" type="password" placeholder="Password (min 6 chars)" style="flex:1;">
        <button id="btnEmailUp">Create account</button>
      </div>
    </div>

    <!-- Email Sign In -->
    <div id="emailInPanel" class="auth-panel">
      <div class="row">
        <input id="emailIn" type="email" placeholder="Email" style="flex:1;">
        <input id="passIn" type="password" placeholder="Password" style="flex:1;">
        <button id="btnEmailIn">Sign in</button>
      </div>
      <div class="row">
        <button id="btnReset" class="link">Forgot password?</button>
      </div>
    </div>

    <!-- Session bar -->
    <div class="bar" style="margin-top:10px;">
      <div>
        <span class="muted">Status:</span>
        <span id="statusText" class="muted">Signed out</span>
      </div>
      <div class="row">
        <span id="userName" class="muted"></span>
        <button id="signOutBtn" style="display:none;">Sign out</button>
      </div>
    </div>

    <div id="errorBox" style="display:none; margin-top:8px;"><span id="errorText" class="err"></span></div>
  </div>

  <!-- Streak -->
  <div id="streakCard" class="card" style="display:none;">
    <div class="bar">
      <div class="section-title" style="margin:0;">Streak</div>
      <div><strong>ðŸ”¥ <span id="streakCount">0</span></strong> days</div>
    </div>
  </div>

  <!-- Tasks -->
  <div class="card">
    <div class="section-title">Tasks</div>
    <div class="row">
      <input id="new-task" placeholder="New taskâ€¦" style="flex:1;" />
      <select id="taskScope">
        <option value="mine">My tasks</option>
        <option value="shared">Shared</option>
      </select>
      <button id="addTaskBtn">Add</button>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px;">
      <div>
        <div class="muted">My tasks</div>
        <ul id="my-task-list"></ul>
      </div>
      <div>
        <div class="muted">Shared</div>
        <ul id="shared-task-list"></ul>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div class="card">
    <div class="section-title">Group Chat</div>
    <div id="chat-box"></div>
    <div class="row">
      <input id="chat-input" placeholder="Type a messageâ€¦" style="flex:1;" />
      <button id="sendMsgBtn">Send</button>
    </div>
  </div>

  <script>
    // helpers
    const $ = s => document.querySelector(s);
    const show = el => el.style.display = '';
    const hide = el => el.style.display = 'none';
    const errBox = $('#errorBox'), errText = $('#errorText');
    const showError = msg => { errText.textContent = msg; show(errBox); console.error(msg); };
    const clearError = () => { errText.textContent=''; hide(errBox); };

    window.onload = function () {
      // auth UI elements
      const btnGoogle = $('#btnGoogle');
      const btnGithub = $('#btnGithub');
      const btnMicrosoft = $('#btnMicrosoft');
      const btnAnon = $('#btnAnon');
      const toggleEmail = $('#toggleEmail');
      const toggleEmailSignIn = $('#toggleEmailSignIn');
      const emailPanel = $('#emailPanel');
      const emailInPanel = $('#emailInPanel');
      const btnEmailUp = $('#btnEmailUp');
      const btnEmailIn = $('#btnEmailIn');
      const btnReset = $('#btnReset');
      const signOutBtn = $('#signOutBtn');
      const statusText = $('#statusText');
      const userName = $('#userName');

      // app UI
      const streakCard = $('#streakCard');
      const streakCount = $('#streakCount');
      const myList = $('#my-task-list');
      const sharedList = $('#shared-task-list');

      let currentUser = null;
      let unsubMyTasks = null, unsubSharedTasks = null, unsubChat = null;

      // provider sign-ins
      btnGoogle.onclick = () => popupSignIn(new firebase.auth.GoogleAuthProvider());
      btnGithub.onclick = () => {
        const p = new firebase.auth.GithubAuthProvider();
        p.addScope('read:user');
        popupSignIn(p);
      };
      btnMicrosoft.onclick = () => {
        const p = new firebase.auth.OAuthProvider('microsoft.com');
        popupSignIn(p);
      };
      btnAnon.onclick = async () => {
        clearError();
        try { await auth.signInAnonymously(); }
        catch(e){ showError('Guest sign-in failed: ' + e.message); }
      };

      async function popupSignIn(provider){
        clearError();
        try {
          await auth.signInWithPopup(provider);
        } catch (e) {
          // some providers may block popups; fallback to redirect
          if (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user') {
            try { await auth.signInWithRedirect(provider); }
            catch(e2){ showError('Sign-in failed: ' + e2.message); }
          } else {
            showError('Sign-in failed: ' + e.message);
          }
        }
      }

      // email flows
      toggleEmail.onclick = () => { emailInPanel.style.display = 'none'; emailPanel.style.display = emailPanel.style.display ? '' : 'block'; };
      toggleEmailSignIn.onclick = () => { emailPanel.style.display = 'none'; emailInPanel.style.display = emailInPanel.style.display ? '' : 'block'; };

      btnEmailUp.onclick = async () => {
        clearError();
        const email = $('#emailUp').value.trim();
        const pass = $('#passUp').value;
        if (!email || !pass) return showError('Enter email and password.');
        try { await auth.createUserWithEmailAndPassword(email, pass); }
        catch(e){ showError('Sign-up failed: ' + e.message); }
      };

      btnEmailIn.onclick = async () => {
        clearError();
        const email = $('#emailIn').value.trim();
        const pass = $('#passIn').value;
        if (!email || !pass) return showError('Enter email and password.');
        try { await auth.signInWithEmailAndPassword(email, pass); }
        catch(e){ showError('Sign-in failed: ' + e.message); }
      };

      btnReset.onclick = async () => {
        clearError();
        const email = ($('#emailIn').value || $('#emailUp').value || '').trim();
        if (!email) return showError('Enter your email above, then click reset.');
        try { await auth.sendPasswordResetEmail(email); alert('Password reset email sent.'); }
        catch(e){ showError('Reset failed: ' + e.message); }
      };

      // sign out
      signOutBtn.onclick = () => auth.signOut();

      // auth state
      auth.onAuthStateChanged(user => {
        // cleanup listeners
        unsubMyTasks && unsubMyTasks(); unsubMyTasks=null;
        unsubSharedTasks && unsubSharedTasks(); unsubSharedTasks=null;
        unsubChat && unsubChat(); unsubChat=null;

        if (user) {
          currentUser = user;
          statusText.textContent = user.isAnonymous ? 'Guest session' : 'Signed in';
          userName.textContent = user.displayName || user.email || '(guest)';
          show(signOutBtn); show(streakCard);
          wireTasks(user.uid);
          wireChat();
          updateStreakUI(user.uid);
        } else {
          currentUser = null;
          statusText.textContent = 'Signed out';
          userName.textContent = '';
          hide(signOutBtn); hide(streakCard);
          myList.innerHTML = ''; sharedList.innerHTML = ''; $('#chat-box').innerHTML='';
        }
      });

      // tasks
      $('#addTaskBtn').onclick = async () => {
        clearError();
        if (!currentUser) return showError('Please sign in first.');
        const text = $('#new-task').value.trim();
        if (!text) return;
        const scope = $('#taskScope').value;
        try {
          const ts = firebase.firestore.FieldValue.serverTimestamp();
          if (scope === 'mine') {
            await db.collection('users').doc(currentUser.uid).collection('tasks').add({ text, completed:false, timestamp:ts });
          } else {
            await db.collection('tasks').add({ text, completed:false, timestamp:ts, author: currentUser.uid || null });
          }
          $('#new-task').value = '';
        } catch(e){ showError('Add task failed: ' + e.message); }
      };

      function wireTasks(uid){
        unsubMyTasks = db.collection('users').doc(uid).collection('tasks')
          .orderBy('timestamp')
          .onSnapshot(s => renderTaskList($('#my-task-list'), s, 'user', uid), e => showError('My tasks: ' + e.message));
        unsubSharedTasks = db.collection('tasks').orderBy('timestamp').limit(100)
          .onSnapshot(s => renderTaskList($('#shared-task-list'), s, 'shared', null), e => showError('Shared tasks: ' + e.message));
      }

      function renderTaskList(container, snapshot, kind, uid){
        const frag = document.createDocumentFragment();
        snapshot.forEach(doc => {
          const d = doc.data();
          const li = document.createElement('li');
          li.className = 'task' + (d.completed ? ' done':'');
          li.dataset.kind = kind; li.dataset.id = doc.id; if (uid) li.dataset.uid = uid;

          const txt = document.createElement('span');
          txt.className = 'txt'; txt.textContent = d.text || '(untitled)';

          const btn = document.createElement('button');
          btn.textContent = d.completed ? 'âœ“' : 'Done';
          btn.onclick = (e)=>{ e.stopPropagation(); markTaskComplete(li.dataset); };

          li.appendChild(txt); li.appendChild(btn);
          frag.appendChild(li);
        });
        container.innerHTML = ''; container.appendChild(frag);
      }

      async function markTaskComplete(meta){
        clearError();
        if (!currentUser) return;
        try{
          if (meta.kind === 'user') {
            await db.collection('users').doc(meta.uid).collection('tasks').doc(meta.id).update({completed:true});
          } else {
            await db.collection('tasks').doc(meta.id).update({completed:true});
          }
          await tickStreak(currentUser.uid);
        } catch(e){ showError('Complete failed: ' + e.message); }
      }

      async function tickStreak(uid){
        const today = new Date().toDateString();
        const ref = db.collection('streaks').doc(uid);
        const snap = await ref.get();
        let next = 1;
        if (snap.exists){
          const data = snap.data();
          const last = data.lastCompleted ? new Date(data.lastCompleted).toDateString() : null;
          const yest = new Date(Date.now()-86400000).toDateString();
          if (last === today) return updateStreakUI(uid);
          next = (last === yest) ? (data.streak||0)+1 : 1;
        }
        await ref.set({streak:next, lastCompleted:today}, {merge:true});
        updateStreakUI(uid);
      }

      function updateStreakUI(uid){
        db.collection('streaks').doc(uid).get().then(s=>{
          if (!s.exists) { streakCount.textContent='0'; return; }
          const d = s.data(); const today = new Date().toDateString();
          const last = d.lastCompleted ? new Date(d.lastCompleted).toDateString():null;
          const yest = new Date(Date.now()-86400000).toDateString();
          streakCount.textContent = (last===today || last===yest) ? (d.streak||0) : 0;
        });
      }

      // chat
      $('#sendMsgBtn').onclick = async () => {
        clearError();
        if (!currentUser) return showError('Please sign in to chat.');
        const msg = $('#chat-input').value.trim();
        if (!msg) return;
        try{
          await db.collection('chat').add({
            name: currentUser.displayName || currentUser.email || 'Guest',
            uid: currentUser.uid || null,
            message: msg,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          $('#chat-input').value='';
        }catch(e){ showError('Send failed: ' + e.message); }
      };

      function wireChat(){
        unsubChat = db.collection('chat').orderBy('timestamp').limit(200)
          .onSnapshot(s=>{
            const frag = document.createDocumentFragment();
            s.forEach(doc=>{
              const d = doc.data();
              const line = document.createElement('div');
              line.className='msg';
              line.innerHTML = `<b>${d.name||'Anon'}</b>: ${d.message||''}`;
              frag.appendChild(line);
            });
            const box = $('#chat-box'); box.innerHTML=''; box.appendChild(frag); box.scrollTop = box.scrollHeight;
          }, e=>showError('Chat error: ' + e.message));
      }
    };
  </script>

  <!-- (Optional) PWA bits if you added them earlier
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=>navigator.serviceWorker.register('./service-worker.js'));
    }
  </script>
  -->
</body>
</html>
