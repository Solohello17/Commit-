<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Commit</title>
  <!-- Tailwind CSS, Inter Font, PWA manifest -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .container { max-width: 800px; }
    .task-list { min-height: 200px; }
    .loading-spinner {
      border: 4px solid rgba(0,0,0,0.1);
      width: 36px; height: 36px; border-radius: 50%;
      border-left-color: #4f46e5;
      animation: spin 1s ease infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .commit-logo { width: 32px; height: 32px; background-color: #4f46e5; border-radius: 8px; position: relative; }
    .commit-logo::before {
      content: "";
      position: absolute;
      top: 8px; left: 8px;
      width: 16px; height: 16px;
      border: 2px solid white;
      border-radius: 4px;
    }
    .text-commit-gradient {
      background-image: linear-gradient(to right, #4f46e5, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .button-gradient {
      background-image: linear-gradient(to right, #4f46e5, #8b5cf6);
      transition: all 0.3s ease;
    }
    .button-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div id="app" class="container mx-auto p-4 md:p-8">

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
      <div class="flex items-center space-x-3 mb-4 md:mb-0">
        <div class="commit-logo"></div>
        <h1 class="text-3xl md:text-4xl font-bold text-commit-gradient">Commit</h1>
      </div>
      <div id="auth-buttons" class="flex space-x-2"></div>
    </div>

    <!-- Authentication or Group Setup -->
    <div id="auth-section" class="bg-white p-6 rounded-xl shadow-lg mb-6"></div>

    <!-- Main App UI -->
    <div id="main-app" class="hidden">
      <!-- Tasks Panel -->
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Tasks</h2>
        <div id="task-input-container" class="flex flex-col md:flex-row items-center md:space-x-2 space-y-2 md:space-y-0 mb-4">
          <input type="text" id="new-task-input" placeholder="Add a new task..."
            class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
          <input type="date" id="task-due-date"
            class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
          <button id="add-task-button"
            class="button-gradient text-white p-3 rounded-lg transition-all shadow-md">Add Task</button>
        </div>
        <div id="task-list-container" class="task-list">
          <div id="task-list" class="space-y-3"></div>
          <p id="no-tasks-message" class="text-gray-500 text-center mt-8 hidden">
            No tasks yet. Get started by adding one!
          </p>
        </div>
      </div>
      <!-- Group View Panel -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Group Accountability</h2>
        <p id="group-id-display" class="text-gray-600 mb-4 text-center md:text-left"></p>
        <div id="member-tasks-container">
          <p class="text-gray-500 text-center mt-4">Loading group tasks...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.error('SW registration failed:', err));
      });
    }
  </script>

  <!-- Firebase & App Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import {
      getAuth, signInWithCustomToken, signInAnonymously, signOut,
      onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import {
      getFirestore, collection, query, where, addDoc, doc, getDoc, setDoc,
      updateDoc, deleteDoc, onSnapshot, runTransaction, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig),
          auth = getAuth(app),
          db = getFirestore(app);

    let userId = null, userEmail = null, userGroup = null;

    const authSection = document.getElementById('auth-section');
    const authButtons = document.getElementById('auth-buttons');
    const mainApp = document.getElementById('main-app');
    const newTaskInput = document.getElementById('new-task-input');
    const dueDateInput = document.getElementById('task-due-date');
    const addTaskButton = document.getElementById('add-task-button');
    const taskList = document.getElementById('task-list');
    const noTasksMessage = document.getElementById('no-tasks-message');
    const groupIdDisplay = document.getElementById('group-id-display');
    const memberTasksContainer = document.getElementById('member-tasks-container');

    function showLoading(container, message) {
      container.innerHTML =
        `<div class="flex flex-col items-center justify-center p-8">
           <div class="loading-spinner"></div>
           <p class="mt-4 text-gray-600">${message}</p>
        </div>`;
    }

    function showMessage(container, msg, type = 'info') {
      const color = type === 'error' ? 'red' : 'green';
      container.innerHTML = `<p class="text-sm text-center text-${color}-600 font-medium">${msg}</p>`;
    }

    function formatDueDate(dateStr) {
      const today = new Date();
      const due = new Date(dateStr);
      const diff = Math.floor((due - today) / (1000 * 60 * 60 * 24));
      if (diff < 0) return 'Overdue';
      if (diff === 0) return 'Due Today';
      if (diff === 1) return 'Due Tomorrow';
      return 'Due: ' + due.toLocaleDateString();
    }

    function renderTasks(tasks) {
      taskList.innerHTML = '';
      if (tasks.length === 0) {
        noTasksMessage.classList.remove('hidden');
      } else {
        noTasksMessage.classList.add('hidden');
        tasks.forEach(task => {
          const dueLabel = task.dueDate ? formatDueDate(task.dueDate) : '';
          const el = document.createElement('div');
          el.className = `flex flex-col md:flex-row md:items-center md:justify-between p-3 rounded-lg ${task.completed ? 'bg-green-100' : 'bg-gray-100'} transition-all`;
          el.innerHTML = `
            <div class="flex flex-col md:flex-row md:items-center md:space-x-3">
              <div class="flex items-center space-x-3">
                <input type="checkbox" ${task.completed ? 'checked' : ''} class="w-5 h-5 text-indigo-600 bg-gray-200 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                <span class="${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task.text}</span>
              </div>
              ${dueLabel ? `<span class="mt-2 md:mt-0 inline-block text-xs bg-indigo-100 text-indigo-600 font-semibold px-2 py-1 rounded">${dueLabel}</span>` : ''}
            </div>
            <button class="delete-task-btn p-2 text-red-500 hover:text-red-700 transition-colors rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1â€¦" clip-rule="evenodd"/>
              </svg>
            </button>`;
          el.querySelector('input[type="checkbox"]').addEventListener('change', () => toggleTaskCompletion(task.id, task.completed));
          el.querySelector('.delete-task-btn').addEventListener('click', () => deleteTask(task.id));
          taskList.appendChild(el);
        });
      }
    }

    let unsubscribeTasks = null;
    function setupTaskListener() {
      if (unsubscribeTasks) unsubscribeTasks();
      const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), where('groupId', '==', userGroup));
      unsubscribeTasks = onSnapshot(q, snapshot => {
        const tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTasks(tasks);
      }, err => console.error('Error listening tasks:', err));
    }

    function renderGroupUI() {
      if (userGroup) {
        groupIdDisplay.innerHTML = `You are in a group with ID: <span class="font-bold text-indigo-600 break-all">${userGroup}</span>`;
        setupMemberTasksListener();
        setupTaskListener();
      } else {
        groupIdDisplay.textContent = 'You are not in a group.';
        memberTasksContainer.innerHTML = `
          <div class="space-y-4 text-center md:text-left">
            <p class="text-gray-700">Join a group to collaborate and see shared tasks.</p>
            <form id="group-form" class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-2">
              <input type="text" id="group-id-input" placeholder="Enter Group ID"
                class="w-full md:w-auto flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
              <button type="submit" id="join-group-button"
                class="button-gradient w-full md:w-auto text-white p-3 rounded-lg shadow-md">Join Group</button>
            </form>
            <p class="text-sm text-gray-500">Or</p>
            <button id="create-group-button" class="bg-green-500 w-full md:w-auto text-white p-3 rounded-lg hover:bg-green-600 transition-colors shadow-md">Create New Group</button>
            <div id="group-message" class="mt-4"></div>
          </div>`;
        document.getElementById('group-form').addEventListener('submit', handleGroupFormSubmit);
        document.getElementById('create-group-button').addEventListener('click', handleCreateGroup);
      }
    }

    async function handleGroupFormSubmit(e) {
      e.preventDefault();
      const gid = document.getElementById('group-id-input').value.trim();
      const msg = document.getElementById('group-message');
      if (!gid) return showMessage(msg, 'Please enter a Group ID.', 'error');
      showLoading(msg, 'Joining group...');
      try {
        const groupRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', gid);
        const groupSnap = await getDoc(groupRef);
        if (groupSnap.exists()) {
          await runTransaction(db, async tx => {
            const data = groupSnap.data();
            const existing = Array.isArray(data.members) ? data.members : [];
            const updated = [...existing, { id: userId, email: userEmail }];
            tx.update(groupRef, { members: updated });
          });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), { groupId: gid });
          userGroup = gid;
          renderGroupUI();
          showMessage(msg, 'Successfully joined the group!', 'success');
        } else {
          showMessage(msg, 'Group not found. Please check the ID.', 'error');
        }
      } catch (err) {
        showMessage(msg, `Error joining group: ${err.message}`, 'error');
      }
    }

    async function handleCreateGroup() {
      const msg = document.getElementById('group-message');
      showLoading(msg, 'Creating new group...');
      try {
        const newGroupRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'groups'));
        const gid = newGroupRef.id;
        await setDoc(newGroupRef, { createdAt: serverTimestamp(), members: [{ id: userId, email: userEmail }] });
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), { groupId: gid });
        userGroup = gid;
        renderGroupUI();
        showMessage(msg, `New group created! Share this ID with your friends: <span class="font-bold text-indigo-600">${gid}</span>`, 'success');
      } catch (err) {
        showMessage(msg, `Error creating group: ${err.message}`, 'error');
      }
    }

    let unsubscribeMemberTasks = null;
    function setupMemberTasksListener() {
      if (unsubscribeMemberTasks) unsubscribeMemberTasks();
      if (!userGroup) {
        memberTasksContainer.innerHTML = '<p class="text-gray-500 text-center mt-4">You must be in a group to see shared tasks.</p>';
        return;
      }
      const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), where('groupId', '==', userGroup));
      unsubscribeMemberTasks = onSnapshot(q, snapshot => {
        const byMember = {};
        snapshot.docs.forEach(d => {
          const t = { id: d.id, ...d.data() };
          byMember[t.userName] = byMember[t.userName] || [];
          byMember[t.userName].push(t);
        });
        renderMemberTasks(byMember);
      }, err => console.error('Error listening group tasks:', err));
    }

    function renderMemberTasks(byMember) {
      memberTasksContainer.innerHTML = '';
      const names = Object.keys(byMember);
      if (names.length === 0) {
        memberTasksContainer.innerHTML = '<p class="text-gray-500 text-center mt-4">No tasks have been added to this group yet.</p>';
        return;
      }
      names.forEach(name => {
        const section = document.createElement('div');
        section.className = 'mb-6 border-b border-gray-200 pb-4';
        section.innerHTML = `
          <h3 class="text-lg font-bold text-indigo-800 mb-2">${name}</h3>
          <ul class="list-disc pl-5 space-y-1">
            ${byMember[name].map(task => `<li class="${task.completed ? 'text-gray-500 line-through' : 'text-gray-800'}">${task.text}</li>`).join('')}
          </ul>`;
        memberTasksContainer.appendChild(section);
      });
    }

    async function addTask() {
      const text = newTaskInput.value.trim();
      const due = dueDateInput.value;
      if (!text) return;
      if (!userGroup) return alert('Please join or create a group before adding tasks!');
      try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), {
          text,
          completed: false,
          createdAt: serverTimestamp(),
          dueDate: due || null,
          userId, userName: userEmail, groupId: userGroup
        });
        newTaskInput.value = '';
        dueDateInput.value = '';
        newTaskInput.focus();
      } catch (err) {
        console.error('Error adding task:', err);
      }
    }

    async function toggleTaskCompletion(id, completed) {
      try {
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id), { completed: !completed });
      } catch (err) {
        console.error('Error toggling:', err);
      }
    }

    async function deleteTask(id) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id));
      } catch (err) {
        console.error('Error deleting task:', err);
      }
    }

    onAuthStateChanged(auth, async user => {
      if (user) {
        userId = user.uid;
        userEmail = user.email || 'Anonymous';
        const uRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
        const uSnap = await getDoc(uRef);
        if (!uSnap.exists()) {
          await setDoc(uRef, { email: userEmail, createdAt: serverTimestamp(), groupId: null });
        } else {
          userGroup = uSnap.data().groupId;
        }
        renderAuthUI(true);
      } else {
        userId = userEmail = userGroup = null;
        renderAuthUI(false);
      }
    });

    async function renderAuthUI(loggedIn) {
      authButtons.innerHTML = '';
      authSection.innerHTML = '';
      if (loggedIn) {
        mainApp.classList.remove('hidden');
        const welcome = document.createElement('p');
        welcome.className = 'text-gray-700 text-sm md:text-base';
        welcome.textContent = `Welcome, ${userEmail}!`;
        const signOutBtn = document.createElement('button');
        signOutBtn.className = 'bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors shadow-md';
        signOutBtn.textContent = 'Sign Out';
        signOutBtn.onclick = () => signOut(auth);
        authButtons.appendChild(welcome);
        authButtons.appendChild(signOutBtn);
        renderGroupUI();
      } else {
        mainApp.classList.add('hidden');
        authSection.innerHTML = `
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">Account</h2>
          <div id="auth-message" class="mb-4"></div>
          <form id="auth-form" class="space-y-4">
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
            <button type="submit" class="button-gradient w-full text-white p-3 rounded-lg shadow-md">Sign Up / Sign In</button>
          </form>`;
        document.getElementById('auth-form').addEventListener('submit', async e => {
          e.preventDefault();
          const email = document.getElementById('auth-email').value;
          const pwd = document.getElementById('auth-password').value;
          const msgc = document.getElementById('auth-message');
          if (!email || !pwd) return showMessage(msgc, 'Please enter both email and password.', 'error');
          showLoading(msgc, 'Processing...');
          try {
            await signInWithEmailAndPassword(auth, email, pwd);
            showMessage(msgc, 'Signed in successfully!', 'success');
          } catch (err) {
            if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
              try {
                await createUserWithEmailAndPassword(auth, email, pwd);
                showMessage(msgc, 'Signed up successfully!', 'success');
              } catch (e2) {
                showMessage(msgc, `Sign up failed: ${e2.message}`, 'error');
              }
            } else {
              showMessage(msgc, `Authentication failed: ${err.message}`, 'error');
            }
          }
        });
      }
    }

    (async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error('Authentication failed:', err);
      }
    })();

    addTaskButton.addEventListener('click', addTask);
    newTaskInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') addTask();
    });
  </script>
</body>
</html>
